name: L7 Smart Checker (Scheduled)
on:
  schedule:
    - cron: '0 */3 * * *' # Запуск каждые 3 часа
  workflow_dispatch: # Чтобы ты мог запустить проверку вручную кнопкой

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Checker Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Warp
        uses: fscarmen/warp-on-actions@v1.1
        with:
          stack: dual

      - name: Fetch Ultra Elite Nodes
        run: |
          # Скачиваем файл из твоей основной репы
          curl -L "https://raw.githubusercontent.com/shrau77/hpp/main/ultra_elite.txt" -o input.txt

      - name: Prepare and Run Go Checker
        run: |
          # Инициализация и зависимости (если Go код их требует)
          go mod init proxy-checker || true
          go get github.com/oschwald/geoip2-golang
          go get golang.org/x/net/proxy
          
          # Сборка и запуск
          go build -o checker main.go
          ./checker --input input.txt

      - name: Push Results to HPP
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Клонируем основную репу для записи результатов
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/shrau77/hpp.git target_repo
          
          # Переносим файлы скоростей в основную репу
          # Скрипт Клода должен генерировать именно эти названия
          cp uf.txt fast.txt norm.txt target_repo/
          
          cd target_repo
          git config user.name "L7-Checker-Bot"
          git config user.email "bot@github.com"
          
          git add uf.txt fast.txt norm.txt
          # Фиксируем изменения. Если файлов нет или они не изменились, скрипт просто пойдет дальше
          git commit -m "L7 Update (Scheduled): $(date +'%Y-%m-%d %H:%M')" || exit 0
          git push
