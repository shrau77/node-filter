name: L7 Smart Checker (Matrix)
on:
  schedule:
    - cron: '17 */4 * * *' # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å workflow –≤—Ä—É—á–Ω—É—é

permissions:
  contents: write

jobs:
  prepare-inputs:
    runs-on: ubuntu-latest
    outputs:
      matrix_json: ${{ steps.set-matrix.outputs.matrix_json }}
    steps:
      - name: Checkout Checker Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Fetch All Node Lists
        run: |
          curl -L "https://raw.githubusercontent.com/shrau77/hpp/main/output/ultra_elite.txt" -o ultra_elite_raw.txt
          curl -L "https://raw.githubusercontent.com/shrau77/hpp/main/output/business.txt" -o business_raw.txt

      - name: Combine and Split Lists
        run: |
          # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ñ–∞–π–ª—ã
          cat ultra_elite_raw.txt business_raw.txt > combined_input_full.txt
          
          # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
          sed -i '/^$/d' combined_input_full.txt

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ (600 —Å—Ç—Ä–æ–∫ –Ω–∞ –≤–æ—Ä–∫–µ—Ä)
          CHUNK_SIZE=600
          mkdir -p input_chunks
          split -l $CHUNK_SIZE combined_input_full.txt input_chunks/chunk_

          echo "Created chunks:"
          ls -la input_chunks/

      - name: Generate Matrix JSON
        id: set-matrix
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Python –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∞–ª–∏–¥–Ω–æ–≥–æ JSON, —Ç–∞–∫ –∫–∞–∫ bash —á–∞—Å—Ç–æ –æ—à–∏–±–∞–µ—Ç—Å—è —Å –∑–∞–ø—è—Ç—ã–º–∏
          python3 -c '
          import os, json
          files = sorted([f for f in os.listdir("input_chunks") if f.startswith("chunk_")])
          matrix = [{"input_file": f} for f in files]
          print(f"matrix_json={json.dumps(matrix)}")
          ' >> $GITHUB_OUTPUT

      - name: Upload Input Chunks
        uses: actions/upload-artifact@v4
        with:
          name: input-chunks
          path: input_chunks/
          retention-days: 1

  check-chunks:
    needs: prepare-inputs
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # –ï—Å–ª–∏ –æ–¥–∏–Ω —á–∞–Ω–∫ —É–ø–∞–¥–µ—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç—É
      matrix:
        include: ${{ fromJson(needs.prepare-inputs.outputs.matrix_json) }}
    steps:
      - name: Checkout Checker Code
        uses: actions/checkout@v4

      - name: Download Input Chunks
        uses: actions/download-artifact@v4
        with:
          name: input-chunks
          path: input_chunks

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Warp
        uses: fscarmen/warp-on-actions@v1.1
        with:
          stack: dual

      - name: Fetch Whitelist
        run: |
          curl -L "https://raw.githubusercontent.com/shrau77/hpp/main/target_sni.txt" -o whitelist.txt || touch whitelist.txt

      - name: Prepare Input File
        run: |
          cp "input_chunks/${{ matrix.input_file }}" input.txt
          echo "Processing ${{ matrix.input_file }} with $(wc -l < input.txt) lines"

      - name: Build and Run Checker
        run: |
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          go mod init checker || true
          go get github.com/oschwald/geoip2-golang
          go get golang.org/x/net/proxy
          go mod tidy
          
          # –°–±–æ—Ä–∫–∞
          go build -o checker main.go
          chmod +x checker
          
          # –ó–∞–ø—É—Å–∫ (Xray –∏ GeoIP —Å–∫–∞—á–∞—é—Ç—Å—è —Å–∞–º–∏–º —á–µ–∫–µ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
          ./checker -input input.txt -whitelist whitelist.txt

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.input_file }}
          path: |
            uf.txt
            fast.txt
            norm.txt
          retention-days: 1
          if-no-files-found: ignore

  combine-results:
    needs: [prepare-inputs, check-chunks]
    runs-on: ubuntu-latest
    if: always() # –ó–∞–ø—É—Å–∫–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ —á–∞–Ω–∫–∏ —É–ø–∞–ª–∏
    steps:
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          pattern: results-*
          path: all_results
          merge-multiple: false

      - name: Combine Files
        run: |
          touch uf.txt fast.txt norm.txt
          
          # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∞–ø–∫–∞–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          find all_results -name "uf.txt" -exec cat {} + >> uf.txt
          find all_results -name "fast.txt" -exec cat {} + >> fast.txt
          find all_results -name "norm.txt" -exec cat {} + >> norm.txt
          
          echo "Combined stats:"
          wc -l uf.txt fast.txt norm.txt

      - name: Push to HPP Repo
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/shrau77/hpp.git target_repo
          cd target_repo
          git config user.name "L7-Matrix-Bot"
          git config user.email "bot@github.com"

          cp ../uf.txt .
          cp ../fast.txt .
          cp ../norm.txt .

          git add uf.txt fast.txt norm.txt
          git commit -m "L7 Matrix Update: $(date +'%Y-%m-%d %H:%M')" || echo "No changes to commit"
          git push

      - name: Send Telegram Notification
        if: success()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          UF=$(grep -c "://" uf.txt || echo 0)
          FAST=$(grep -c "://" fast.txt || echo 0)
          NORM=$(grep -c "://" norm.txt || echo 0)

          MESSAGE="üöÄ *L7 Matrix Check Results* üöÄ%0A%0Aüíé *Ultra Fast:* $UF%0A‚ö° *Fast:* $FAST%0A‚úÖ *Normal:* $NORM%0A%0Aüì¶ _Results pushed to HPP_"

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d "chat_id=$CHAT_ID" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
