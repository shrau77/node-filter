name: L7 Smart Checker (Matrix)
on:
  schedule:
    - cron: '17 */4 * * *' # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
  workflow_dispatch: # –ß—Ç–æ–±—ã —Ç—ã –º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä—É—á–Ω—É—é –∫–Ω–æ–ø–∫–æ–π

# –¢—Ä–µ–±—É–µ—Ç—Å—è permissions –¥–ª—è –ø—É—à–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
permissions:
  contents: write

jobs:
  prepare-inputs:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Checker Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Fetch All Node Lists
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ —Ç–≤–æ–µ–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–ø—ã
          curl -L "https://raw.githubusercontent.com/shrau77/hpp/main/ultra_elite.txt" -o ultra_elite_raw.txt
          curl -L "https://raw.githubusercontent.com/shrau77/hpp/main/business.txt" -o business_raw.txt

      - name: Combine and Split Lists
        id: split
        run: |
          # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ñ–∞–π–ª—ã
          cat ultra_elite_raw.txt business_raw.txt > combined_input_full.txt

          # –£–∑–Ω–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
          TOTAL_LINES=$(wc -l < combined_input_full.txt)
          echo "Total lines in combined input: $TOTAL_LINES"

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000 —Å—Ç—Ä–æ–∫ –Ω–∞ job)
          CHUNK_SIZE=1000
          echo "Chunk size: $CHUNK_SIZE"

          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —á–∞—Å—Ç–µ–π
          mkdir -p input_chunks

          # –†–∞–∑–±–∏–≤–∞–µ–º —Ñ–∞–π–ª
          split -l $CHUNK_SIZE combined_input_full.txt input_chunks/chunk_
          # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–∏–≤—à–∏—Ö—Å—è —Ñ–∞–π–ª–æ–≤ (job'–æ–≤)
          NUM_JOBS=$(ls input_chunks/chunk_* | wc -l)
          echo "Number of jobs (chunks): $NUM_JOBS"
          echo "num_jobs=$NUM_JOBS" >> $GITHUB_OUTPUT

      - name: Set Matrix
        id: set-matrix
        run: |
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º JSON –º–∞—Å—Å–∏–≤ –¥–ª—è matrix —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
          MATRIX_JSON="["
          for FILENAME in input_chunks/chunk_*; do
              if [ "$MATRIX_JSON" != "[" ]; then
                  MATRIX_JSON="$MATRIX_JSON,"
              fi
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
              MATRIX_JSON="$MATRIX_JSON{\"input_file\":\"$FILENAME\"}"
          done
          MATRIX_JSON="$MATRIX_JSON]"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Generated matrix: $MATRIX_JSON"


  check-chunks:
    needs: prepare-inputs
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-inputs.outputs.matrix) }}
    steps:
      - name: Checkout Checker Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Warp (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–ª—è –æ–±—Ö–æ–¥–∞)
        uses: fscarmen/warp-on-actions@v1.1
        with:
          stack: dual

      # –°–∫–∞—á–∏–≤–∞–µ–º whitelist.txt (–µ—Å–ª–∏ –æ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ —Ä–µ–ø–µ hpp –∏–ª–∏ —á–µ–∫–µ—Ä–∞)
      - name: Fetch Whitelist
        run: |
          curl -L "https://raw.githubusercontent.com/shrau77/hpp/main/target_sni.txt" -o whitelist.txt || echo "whitelist.txt not found, creating empty one." && touch whitelist.txt

      # –ö–æ–ø–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–π —á–∞–Ω–∫ –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π input.txt –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ job'–∞
      - name: Copy Input Chunk
        run: |
          cp "${{ matrix.input_file }}" input.txt
      - name: Prepare and Run Go Checker
        run: |
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ Go –∫–æ–¥ –∏—Ö —Ç—Ä–µ–±—É–µ—Ç)
          go mod init proxy-checker || true
          go get github.com/oschwald/geoip2-golang
          go get golang.org/x/net/proxy

          # –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ input —Ñ–∞–π–ª–∞ –∏ whitelist —Ñ–∞–π–ª–∞
          go build -o checker main.go
          ./checker -input input.txt -whitelist whitelist.txt

      # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ uf.txt, fast.txt, norm.txt –≤ –∫–∞–∂–¥–æ–º job'–µ
      # –≠—Ç–∏ —Ñ–∞–π–ª—ã –Ω—É–∂–Ω–æ –∫–∞–∫-—Ç–æ —Å–æ–±—Ä–∞—Ç—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö job'–æ–≤.
      # –ú—ã –∏—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã.
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.input_file }} # –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ job'–∞
          path: |
            uf.txt
            fast.txt
            norm.txt
          retention-days: 1 # –•—Ä–∞–Ω–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–æ, —Ç.–∫. –æ–Ω–∏ –±—É–¥—É—Ç —Å–æ–±—Ä–∞–Ω—ã


  combine-results:
    needs: [prepare-inputs, check-chunks] # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±–æ–∏—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö job'–æ–≤
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Checker Code (for scripts if needed)
        uses: actions/checkout@v4

      - name: Download All Result Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_results
          pattern: results-* # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å results-

      - name: Combine Result Files
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ –∏—Ç–æ–≥–æ–≤—ã–µ —Ñ–∞–π–ª—ã
          touch combined_uf.txt combined_fast.txt combined_norm.txt

          # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Ñ–∞–π–ª—ã
          for dir in all_results/results-*/; do
            if [ -f "$dir/uf.txt" ]; then
              cat "$dir/uf.txt" >> combined_uf.txt
              echo "Appended uf.txt from $dir"
            fi            if [ -f "$dir/fast.txt" ]; then
              cat "$dir/fast.txt" >> combined_fast.txt
              echo "Appended fast.txt from $dir"
            fi
            if [ -f "$dir/norm.txt" ]; then
              cat "$dir/norm.txt" >> combined_norm.txt
              echo "Appended norm.txt from $dir"
            fi
          done

          # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
          mv combined_uf.txt uf.txt
          mv combined_fast.txt fast.txt
          mv combined_norm.txt norm.txt

          ls -lh *.txt # –ü–æ–∫–∞–∑–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–µ —Ñ–∞–π–ª—ã

      - name: Push Combined Results to HPP
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ä–µ–ø—É –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/shrau77/hpp.git target_repo

          cd target_repo
          git config user.name "L7-Matrix-Checker-Bot"
          git config user.email "bot@github.com"

          # –ö–æ–ø–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–ª–æ–Ω —Ä–µ–ø–æ
          cp ../uf.txt .
          cp ../fast.txt .
          cp ../norm.txt .

          git add uf.txt fast.txt norm.txt
          # –§–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ—Å—Ç–æ –ø–æ–π–¥–µ—Ç –¥–∞–ª—å—à–µ
          git commit -m "L7 Matrix Update: $(date +'%Y-%m-%d %H:%M')" || exit 0
          git push

      - name: Send Summary to Telegram
        if: success()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –∏—Ç–æ–≥–æ–≤—ã—Ö —Ñ–∞–π–ª–∞—Ö (—É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ —Ñ–∞–π–ª–æ–≤ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å)
          UF=$([ -f uf.txt ] && grep -c "://" uf.txt || echo 0)
          FAST=$([ -f fast.txt ] && grep -c "://" fast.txt || echo 0)
          NORM=$([ -f norm.txt ] && grep -c "://" norm.txt || echo 0)

          MESSAGE="üöÄ *L7 Matrix Check Results* üöÄ%0A%0Aüíé *Ultra Fast:* $UF%0A‚ö° *Fast:* $FAST%0A‚úÖ *Normal:* $NORM%0A%0Aüì¶ _Results pushed to HPP_"
          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d "chat_id=$CHAT_ID" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
