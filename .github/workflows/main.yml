name: L7 Smart Checker (Scheduled)
on:
  schedule:
    - cron: '17 */4 * * *' # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
  workflow_dispatch: # –ß—Ç–æ–±—ã —Ç—ã –º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä—É—á–Ω—É—é –∫–Ω–æ–ø–∫–æ–π

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Checker Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Warp
        uses: fscarmen/warp-on-actions@v1.1
        with:
          stack: dual

      - name: Fetch Ultra Elite Nodes
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏–∑ —Ç–≤–æ–µ–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–ø—ã
          curl -L "https://raw.githubusercontent.com/shrau77/hpp/main/ultra_elite.txt" -o proxies.txt

      - name: Prepare and Run Go Checker
        run: |
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ Go –∫–æ–¥ –∏—Ö —Ç—Ä–µ–±—É–µ—Ç)
          go mod init proxy-checker || true
          go get github.com/oschwald/geoip2-golang
          go get golang.org/x/net/proxy
          
          # –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
          go build -o checker main.go
          ./checker --input input.txt

      - name: Push Results to HPP
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ä–µ–ø—É –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/shrau77/hpp.git target_repo
          
          # –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Ñ–∞–π–ª—ã —Å–∫–æ—Ä–æ—Å—Ç–µ–π –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ä–µ–ø—É
          # –°–∫—Ä–∏–ø—Ç –ö–ª–æ–¥–∞ –¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è
          cp uf.txt fast.txt norm.txt target_repo/
          
          cd target_repo
          git config user.name "L7-Checker-Bot"
          git config user.email "bot@github.com"
          
          git add uf.txt fast.txt norm.txt
          # –§–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ—Å—Ç–æ –ø–æ–π–¥–µ—Ç –¥–∞–ª—å—à–µ
          git commit -m "L7 Update (Scheduled): $(date +'%Y-%m-%d %H:%M')" || exit 0
          git push
      - name: Send Summary to Telegram
        if: success()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–∞—Ö (—É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ —Ñ–∞–π–ª–æ–≤ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å)
          UF=$([ -f uf.txt ] && grep -c "://" uf.txt || echo 0)
          FAST=$([ -f fast.txt ] && grep -c "://" fast.txt || echo 0)
          NORM=$([ -f norm.txt ] && grep -c "://" norm.txt || echo 0)
          
          MESSAGE="üöÄ *L7 Check Results* üöÄ%0A%0Aüíé *Ultra Fast:* $UF%0A‚ö° *Fast:* $FAST%0A‚úÖ *Normal:* $NORM%0A%0Aüì¶ _Results pushed to HPP_"
          
          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d "chat_id=$CHAT_ID" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
